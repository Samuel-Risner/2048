(()=>{"use strict";const e={animation:{durationMS:750},field:{size:4},style:{widthPerUnitPx:100},localStorage:{highScoreKey:"highScore"}};function*t(e,t,l){for(let n=0;n<l;n++)yield[e[n][t],t,n];return null}function*l(l){for(let n=0;n<e.field.size;n++)for(let i=0;i<e.field.size+1;i++)yield()=>t(l,n,i);return null}function*n(t,l,n){for(let i=e.field.size-1;i>e.field.size-n;i--)yield[t[i][l],l,i];return null}function*i(t){for(let l=0;l<e.field.size;l++)for(let i=1;i<e.field.size+2;i++)yield()=>n(t,l,i);return null}function*o(e,t,l){for(let n=0;n<l;n++)yield[e[t][n],n,t];return null}function*s(t){for(let l=0;l<t.length;l++)for(let n=1;n<e.field.size+1;n++)yield()=>o(t,l,n);return null}function*r(t,l,n){for(let i=e.field.size-1;i>e.field.size-n;i--)yield[t[l][i],i,l];return null}function*a(t){for(let l=0;l<e.field.size;l++)for(let n=1;n<e.field.size+2;n++)yield()=>r(t,l,n);return null}let u=0,c=0;const d=document.getElementById("score"),h=document.getElementById("highScore");function f(t){t<c||(c=t,localStorage.setItem(e.localStorage.highScoreKey,String(t)),h.textContent=String(t))}function g(e){u=e,d.textContent=String(e),f(e)}function y(e){g(u+e)}function m(t,l,n,i){t.style.top=i*e.style.widthPerUnitPx+"px",t.style.left=n*e.style.widthPerUnitPx+"px"}class p{x;y;positionElement;colorElement;textElement;value;hasMerged;constructor(t,l,n){var i;this.x=t,this.y=l,this.positionElement=document.createElement("div"),this.colorElement=document.createElement("div"),this.textElement=document.createElement("div"),(i=this.positionElement).style.position="absolute",i.style.width=`${e.style.widthPerUnitPx}px`,i.style.height=`${e.style.widthPerUnitPx}px`,i.style.display="flex",m(this.positionElement,0,t,l),function(e){e.style.backgroundColor="white",e.style.width="90%",e.style.height="90%",e.style.display="flex",e.style.margin="auto",e.style.borderRadius="10%"}(this.colorElement),function(t){t.style.display="flex",t.style.margin="auto",t.style.fontSize=e.style.widthPerUnitPx/3+"px"}(this.textElement),this.setValue(Math.random()<.1?4:2),n.appendChild(this.positionElement),this.positionElement.appendChild(this.colorElement),this.colorElement.appendChild(this.textElement),this.hasMerged=!1}setValue(e){switch(this.value=e,this.textElement.textContent=String(e),e){case 2:this.colorElement.style.backgroundColor="#FCD0A1";break;case 4:this.colorElement.style.backgroundColor="#B1B695";break;case 8:this.colorElement.style.backgroundColor="#A690A4";break;case 16:this.colorElement.style.backgroundColor="#5E4B56";break;case 32:this.colorElement.style.backgroundColor="#AFD2E9";break;case 64:this.colorElement.style.backgroundColor="#F42272";break;case 128:this.colorElement.style.backgroundColor="#F397D6";break;case 256:this.colorElement.style.backgroundColor="#D7B8F3";break;case 512:this.colorElement.style.backgroundColor="#B8B8F3";break;case 2048:this.colorElement.style.backgroundColor="#deb841";break;default:this.colorElement.style.backgroundColor="white"}}getValue(){return this.value}getX(){return this.x}getY(){return this.y}getHasMerged(){return this.hasMerged}setHasMerged(e){this.hasMerged=e}remove(){this.positionElement.remove()}setAnimation(t,l,n,i){const o=this.positionElement.animate([{left:this.x*e.style.widthPerUnitPx+"px",top:this.y*e.style.widthPerUnitPx+"px"},{left:t*e.style.widthPerUnitPx+"px",top:l*e.style.widthPerUnitPx+"px"}],{duration:e.animation.durationMS,iterations:1});this.x=t,this.y=l,o.onfinish=()=>{o.cancel(),i?.remove(),this.setValue(n),m(this.positionElement,0,this.x,this.y)}}}const x=document.getElementById("root");function w(){const t=window.innerWidth,l=window.innerHeight;if(t>l){const n=l/(e.field.size*e.style.widthPerUnitPx);x.style.transform=`scale(${n})`,x.style.left=(t-e.field.size*e.style.widthPerUnitPx*n)/2+"px",x.style.top="0px"}else{const n=t/(e.field.size*e.style.widthPerUnitPx);x.style.transform=`scale(${n})`,x.style.left="0px",x.style.top=(l-e.field.size*e.style.widthPerUnitPx*n)/2+"px"}}window.onload=()=>{w(),window.onresize=w,function(){const t=localStorage.getItem(e.localStorage.highScoreKey);if(null===t)return void f(0);const l=Number(t);Number.isSafeInteger(l)&&!Number.isNaN(l)&&l>0?f(l):f(0)}()},x.style.width=e.field.size*e.style.widthPerUnitPx+"px",x.style.height=e.field.size*e.style.widthPerUnitPx+"px",x.style.position="relative",x.style.transformOrigin="0% 0% 0px";let E=!1;const b=[];for(let e=0;e<4;e++){b.push([]);for(let t=0;t<4;t++)b[e][t]=null}function P(){const e=[];for(let t=0;t<b.length;t++)for(let l=0;l<b[t].length;l++)null===b[t][l]&&e.push([l,t]);if(0===e.length)return!1;const[t,l]=e[Math.floor(Math.random()*e.length)];return b[l][t]=new p(t,l,x),!0}let k=!1;const v={up:!0,down:!0,left:!0,right:!0};function z(t){for(const l of t)for(let t=0;t<e.field.size;t++){const e=l();let t=e.next().value;if(null===t)continue;let[n,i,o]=t,s=n;for(const[t,l,r]of e)if(null!==t)if(null!==n){{let e=t.getValue();if(null!==s&&s.getValue()===e&&!s.getHasMerged()){t.setAnimation(s.getX(),s.getY(),2*e,s),b[s.getY()][s.getX()]=t,b[r][l]=null,t.setHasMerged(!0),s.setHasMerged(!0),k=!0,y(2*e);continue}}n=t,s=t}else{let e=t.getValue();if(null!==s&&s.getValue()===e&&!s.getHasMerged()){t.setAnimation(s.getX(),s.getY(),2*e,s),b[s.getY()][s.getX()]=t,b[r][l]=null,t.setHasMerged(!0),s.setHasMerged(!0),k=!0,y(2*e);continue}t.setAnimation(i,o,e,null),b[o][i]=t,b[r][l]=null,k=!0}else{if(null===n)continue;i=l,o=r,n=t}}return k?(function(){for(const e of b)for(const t of e)null!==t&&t.setHasMerged(!1)}(),k=!1,setTimeout((()=>{P(),E=!1}),e.animation.durationMS),!0):(E=!1,k=!1,!1)}function M(){if(!(v.up||v.down||v.left||v.right)){alert(`Defeat!\nYour score: ${u}\nYour high score: ${c}`),g(0);for(let e=0;e<b.length;e++)for(let t=0;t<b[e].length;t++)null!==b[e][t]&&(b[e][t].remove(),b[e][t]=null);return v.up=!0,v.down=!0,v.left=!0,v.right=!0,P(),void P()}}document.addEventListener("keydown",(e=>{if(!E){switch(E=!0,e.code){case"ArrowUp":z(l(b))||(v.up=!1);break;case"ArrowDown":z(i(b))||(v.down=!1);break;case"ArrowLeft":z(s(b))||(v.left=!1);break;case"ArrowRight":z(a(b))||(v.right=!1);break;default:return void(E=!1)}M()}}));let C=0,S=0;x.ontouchstart=e=>{e.preventDefault(),C=e.touches[0].clientX,S=e.touches[0].clientY},x.ontouchmove=e=>{e.preventDefault()},x.ontouchend=e=>{if(e.preventDefault(),E)return;E=!0;const t=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY;Math.abs(C-t)<Math.abs(S-n)?S>n?z(l(b))||(v.up=!1):z(i(b))||(v.down=!1):C>t?z(s(b))||(v.left=!1):z(a(b))||(v.right=!1),M()},P(),P(),x.hidden=!1})();